{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>FACTORA POS - Reportes</title>

    <link rel="stylesheet" href="{% static 'css/reportes.css' %}" />
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="{% url 'dashboard' %}" class="logo">FACTORA POS</a>
            <div class="logo-subtitle">Sistema Integrado de GestiÃ³n</div>
        </div>

        <div class="sidebar-menu">
            <a href="{% url 'dashboard' %}" class="menu-item">
                <i>ğŸ“Š</i> Dashboard
            </a>

            <div class="menu-section">Operaciones</div>

            <a href="{% url 'punto_venta' %}" class="menu-item">
                <i>ğŸ›’</i> Punto de Venta
            </a>

            <a href="{% url 'inventario' %}" class="menu-item">
                <i>ğŸ“¦</i> Inventario
            </a>

            <a href="{% url 'clientes' %}" class="menu-item">
                <i>ğŸ‘¥</i> Clientes
            </a>

            <a href="{% url 'proveedores' %}" class="menu-item">
                <i>ğŸ­</i> Proveedores
            </a>

            <div class="menu-section">GestiÃ³n</div>

            <a href="{% url 'reportes' %}" class="menu-item active">
                <i>ğŸ“ˆ</i> Reportes
            </a>

            <a href="{% url 'rma' %}" class="menu-item">
                <i>ğŸ”§</i> RMA / GarantÃ­as
            </a>

            <a href="{% url 'movimientos' %}" class="menu-item">
                <i>ğŸ“‹</i> Movimientos
            </a>

            <div class="menu-section">ConfiguraciÃ³n</div>

            <a href="{% url 'usuarios' %}" class="menu-item">
                <i>ğŸ‘¤</i> Usuarios
            </a>

            <a href="{% url 'config' %}" class="menu-item">
                <i>âš™ï¸</i> ConfiguraciÃ³n
            </a>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="search-box">
            <input type="text" placeholder="Buscar reportes...">
        </div>

        <div class="header-actions">
            <div class="notification-badge">
                <span id="notificationBell" style="font-size: 20px; cursor: pointer;" onclick="toggleNotifications(event)">ğŸ””</span>
                <span class="notification-count" id="notificationCount" aria-hidden="true"></span>

                <div class="notifications-dropdown" id="notificationsDropdown" aria-live="polite">
                    <div class="dropdown-header">
                        <div class="dropdown-title">Notificaciones</div>
                        <div class="dropdown-actions">
                            <button class="btn-small btn-secondary" onclick="clearAllNotifications()">Marcar todas leÃ­das</button>
                        </div>
                    </div>
                    <div class="dropdown-list" id="notificationsList"></div>
                    <div class="dropdown-footer">
                        <a href="{% url 'movimientos' %}">Ver todas</a>
                    </div>
                </div>
            </div>

            <div class="user-profile-wrapper">
                <div class="user-profile" onclick="toggleProfileMenu()">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div>
                        <div id="welcomeText" style="font-weight: 600; font-size: 14px;">Admin Usuario</div>
                        <div id="roleText" style="font-size: 12px; color: #64748b;">Administrador</div>
                    </div>
                </div>

                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-header">
                        <div class="dropdown-avatar">A</div>
                        <div class="dropdown-info">
                            <div class="dropdown-name">Admin Usuario</div>
                            <div class="dropdown-role">Administrador</div>
                        </div>
                    </div>

                    <div class="dropdown-divider"></div>

                    <a href="{% url 'profile' %}" class="dropdown-item">
                        <span>ğŸ‘¤</span> Mi Perfil
                    </a>

                    <a href="{% url 'config' %}" class="dropdown-item">
                        <span>âš™ï¸</span> ConfiguraciÃ³n
                    </a>

                    <div class="dropdown-divider"></div>

                    <a href="#" class="dropdown-item logout" onclick="handleLogout(event)">
                        <span>ğŸšª</span> Cerrar SesiÃ³n
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <div class="page-header">
            <div>
                <div class="page-title">Reportes</div>
                <div class="page-subtitle">AnÃ¡lisis de ventas, inventario y desempeÃ±o</div>
            </div>

            <button id="exportPdfBtn" class="btn-primary" onclick="exportReportPDF()">
                ğŸ“¥ Descargar PDF
            </button>
        </div>

        <!-- Filters -->
        <div class="filters-card">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Tipo de Reporte:</label>
                    <select id="reportType" onchange="updateReportView()">
                        <option value="ventas">Ventas</option>
                        <option value="inventario">Inventario</option>
                        <option value="productos">Productos MÃ¡s Vendidos</option>
                        <option value="stock">Estado de Stock</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>PerÃ­odo:</label>
                    <select id="reportPeriod" onchange="updateReportView()">
                        <option value="hoy">Hoy</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes">Este Mes</option>
                        <option value="trimestre">Este Trimestre</option>
                        <option value="ano">Este AÃ±o</option>
                        <option value="personalizado">Personalizado</option>
                    </select>
                </div>

                <div class="filter-group" id="dateRangeGroup" style="display:none;">
                    <label>Desde:</label>
                    <input type="date" id="startDate" onchange="updateReportView()">

                    <label>Hasta:</label>
                    <input type="date" id="endDate" onchange="updateReportView()">
                </div>

                <button id="clearFiltersBtn" class="btn-secondary" onclick="resetFilters()">Limpiar Filtros</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="report-stats-grid">

            <div class="report-stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-content">
                    <div class="stat-label">Ventas Totales</div>
                    <div class="stat-value" id="totalSales">$0</div>
                </div>
            </div>

            <div class="report-stat-card">
                <div class="stat-icon">ğŸ“¦</div>
                <div class="stat-content">
                    <div class="stat-label">Unidades Vendidas</div>
                    <div class="stat-value" id="totalUnits">0</div>
                </div>
            </div>

            <div class="report-stat-card">
                <div class="stat-icon">ğŸ“Š</div>
                <div class="stat-content">
                    <div class="stat-label">Margen Promedio</div>
                    <div class="stat-value" id="avgMargin">0%</div>
                </div>
            </div>

            <div class="report-stat-card">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-content">
                    <div class="stat-label">Crecimiento vs PerÃ­odo Anterior</div>
                    <div class="stat-value" id="growth">+0%</div>
                </div>
            </div>

        </div>

        <!-- Report Table -->
        <div class="report-card">
            <div class="report-header">
                <h3 id="reportTitle">Reporte de Ventas</h3>

                <div class="report-options">
                    <button class="btn-icon" onclick="printReport()">ğŸ–¨ï¸ Imprimir</button>
                    <button class="btn-icon" onclick="exportReportCSV()">ğŸ“Š Exportar CSV</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="report-table" id="reportTable">
                    <thead>
                        <tr id="reportTableHeader"></tr>
                    </thead>
                    <tbody id="reportTableBody"></tbody>
                </table>
            </div>

            <div class="pagination">
                <button id="prevPage">â† Anterior</button>
                <span id="pageInfo">PÃ¡gina 1 de 1</span>
                <button id="nextPage">Siguiente â†’</button>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-section">

            <div class="chart-card">
                <div class="chart-header">
                    <h3>Ventas por CategorÃ­a</h3>
                </div>
                <canvas id="categoryChart"></canvas>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <h3>Tendencia de Ventas</h3>
                </div>
                <canvas id="trendsChart"></canvas>
            </div>

        </div>
    </div>

    <!-- JS Scripts -->
    <script>
        // FunciÃ³n global de logout
        function handleLogout(event) {
            if (event) event.preventDefault();
            if (confirm('Â¿EstÃ¡ seguro que desea cerrar sesiÃ³n?')) {
                try { sessionStorage.clear(); } catch(e){}
                try { localStorage.removeItem('factora_user_remember'); } catch(e){}
                try { localStorage.removeItem('userToken'); } catch(e){}
                try { localStorage.removeItem('userData'); } catch(e){}
                try { sessionStorage.removeItem('factora_user'); } catch(e){}
                setTimeout(() => {
                    window.location.href = '/';
                }, 100);
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="{% static 'js/auth.js' %}?v={% now 'U' %}"></script>
    <script src="{% static 'js/notifications.js' %}?v={% now 'U' %}"></script>
    <script src="{% static 'js/reportes_v2.js' %}?v={% now 'U' %}"></script>

</body>
</html>
